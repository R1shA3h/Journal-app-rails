<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4">
  <div class="flex flex-col py-8">
    <%= render @note %>

    <div class="flex mt-4">
      <!-- Conditionally render Edit button if permission is 'write' -->

      <%= link_to edit_note_path(@note), class: "ml-2 rounded-lg py-3 px-5 bg-gray-100 inline-block font-medium" do %>
        Edit this note
      <% end if @note.user_id == current_user.id || @shared_note&.note_editable? %>
      <!-- Hide Share button when viewing with permission -->
      <%= link_to "Back to notes", root_path, class: "ml-2 rounded-lg py-3 px-5 bg-gray-100 inline-block font-medium" %>
      <%= link_to "#", id: 'share-button', class: "ml-2 rounded-lg py-3 px-5 bg-blue-600 text-white inline-block font-medium" do %>
        Share
      <% end if @note.user_id == current_user.id %>
    </div>

    <% if @note.user_id == current_user.id %>
      <div class="mt-8">
        <%= button_to "Destroy this note", @note, method: :delete, class: "mt-4 border text-white bg-red-500 rounded-md py-2 px-6" %>
      </div>
    <% end %>
  </div>
</div>


<!-- Share Modal -->
<div id="shareModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg p-6 shadow-lg max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Share Note</h2>
      <%= form_with url: share_note_path(@note), method: :post, local: true, id: "shareForm" do |f| %>
        <div class="mb-4">
          <%= f.label :recipient_email, "Recipient Email" %>
          <%= f.email_field :recipient_email, class: "border p-2 w-full", required: true %>
        </div>
        <div class="mb-4">
          <%= f.label :permission, "Permission" %>
          <%= f.select :permission, options_for_select([['Read', 'read'], ['Read + Write', 'write']], 'read'), class: "border p-2 w-full" %>
        </div>
        <div class="flex justify-end">
          <%= f.submit "Share", class: "bg-blue-600 text-white py-2 px-4 rounded" %>
          <button type="button" id="closeModal" class="ml-4 bg-gray-400 text-white py-2 px-4 rounded">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.getElementById("share-button").onclick = function(event) {
    event.preventDefault();
    const visibility = "<%= @note.visibility %>";

    if (visibility === "public") {
      const noteUrl = "<%= note_url(@note) %>";
      navigator.clipboard.writeText(noteUrl).then(() => {
        alert("Public URL copied to clipboard: " + noteUrl);
      });
    } else if (visibility === "private") {
      alert("Private notes can't be shared.");
    } else if (visibility === "shared") {
      document.getElementById("shareModal").classList.remove("hidden");
    }
  };

  document.getElementById("closeModal").onclick = function() {
    document.getElementById("shareModal").classList.add("hidden");
  };

  // Handle form submission
  document.getElementById("shareForm").onsubmit = function(event) {
    event.preventDefault(); // Prevent default form submission

    const formData = new FormData(this);
    
    fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content') // CSRF token for security
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        alert(data.message); // Show success message
        document.getElementById("shareModal").classList.add("hidden"); // Close modal
      } else if (data.error) {
        alert(data.error); // Show error message
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("An error occurred while sharing the note.");
    });
  };
</script>
